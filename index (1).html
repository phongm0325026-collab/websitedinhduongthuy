<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ph·ªëi h·ª£p kh·∫©u ph·∫ßn th·ª©c ƒÉn ‚Äì Gia s√∫c, gia c·∫ßm & Th·ªßy s·∫£n</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root{--glass: rgba(255,255,255,.72);--glass2: rgba(255,255,255,.55)}
    body{background: radial-gradient(1200px 600px at 10% 0%, #dbeafe 0%, transparent 60%),
                 radial-gradient(900px 500px at 90% 10%, #dcfce7 0%, transparent 55%),
                 radial-gradient(800px 500px at 50% 100%, #fef9c3 0%, transparent 60%),
                 linear-gradient(180deg,#f8fafc 0%, #ffffff 65%, #f8fafc 100%);
         min-height:100vh;}

    /* Moving animals */
    .sky{position:fixed; inset:0; pointer-events:none; overflow:hidden;}
    .animal{position:absolute; font-size: clamp(22px, 3vw, 42px); filter: drop-shadow(0 10px 12px rgba(0,0,0,.12)); opacity:.92;}
    .animal.small{font-size: clamp(18px, 2.2vw, 34px); opacity:.85;}
    .animal.tiny{font-size: clamp(14px, 1.6vw, 26px); opacity:.78;}

    @keyframes drift1{0%{transform:translate(-15vw,10vh) rotate(-6deg)} 50%{transform:translate(55vw,14vh) rotate(6deg)} 100%{transform:translate(115vw,8vh) rotate(-4deg)}}
    @keyframes drift2{0%{transform:translate(110vw,30vh) scaleX(-1)} 50%{transform:translate(45vw,36vh) scaleX(-1)} 100%{transform:translate(-20vw,32vh) scaleX(-1)}}
    @keyframes drift3{0%{transform:translate(-20vw,70vh) rotate(2deg)} 50%{transform:translate(35vw,66vh) rotate(-3deg)} 100%{transform:translate(120vw,72vh) rotate(2deg)}}
    @keyframes swim{0%{transform:translate(-25vw,52vh)} 50%{transform:translate(40vw,48vh)} 100%{transform:translate(125vw,54vh)}}
    @keyframes bob{0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)}}

    .a1{animation: drift1 26s linear infinite;}
    .a2{animation: drift2 32s linear infinite;}
    .a3{animation: drift3 28s linear infinite;}
    .a4{animation: swim 22s linear infinite;}
    .bob{animation: bob 2.8s ease-in-out infinite;}

    /* Cards */
    .glass{background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(15,23,42,.10)}
    .glass2{background: var(--glass2); backdrop-filter: blur(10px); border: 1px solid rgba(15,23,42,.10)}

    /* Table */
    .table-wrap{overflow:auto; border-radius: 14px;}
    table{border-collapse: separate; border-spacing:0; min-width: 920px; width:100%;}
    th,td{padding:.55rem .6rem; border-bottom: 1px solid rgba(2,6,23,.08)}
    thead th{position: sticky; top:0; z-index:1; background: rgba(255,255,255,.78); backdrop-filter: blur(8px);}

    /* Inputs */
    input[type="number"], input[type="text"], select{outline:none;}

    /* Print */
    @media print{
      .no-print{display:none !important}
      body{background:#fff}
      .glass,.glass2{background:#fff; backdrop-filter:none;}
      table{min-width:0}
    }
  </style>
</head>
<body class="text-slate-900">
  <!-- Moving animals layer -->
  <div class="sky" aria-hidden="true">
    <div class="animal a1" style="top:6vh; left:-20vw">üêî</div>
    <div class="animal small a2" style="top:22vh; left:110vw">üê∑</div>
    <div class="animal a3" style="top:64vh; left:-20vw">üêÑ</div>
    <div class="animal small a4" style="top:48vh; left:-25vw">üêü</div>
    <div class="animal tiny bob" style="top:12vh; left:16vw">ü¶ê</div>
    <div class="animal tiny bob" style="top:78vh; left:78vw">ü¶Ü</div>
  </div>

  <header class="no-print sticky top-0 z-40 border-b border-slate-200/60 bg-white/60 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-emerald-500 text-white grid place-items-center font-bold">FM</div>
      <div class="flex-1">
        <h1 class="text-base sm:text-lg font-semibold leading-tight">Tr√¨nh ph·ªëi h·ª£p kh·∫©u ph·∫ßn th·ª©c ƒÉn (gia s√∫c, gia c·∫ßm & th·ªßy s·∫£n)</h1>
        <p class="text-xs sm:text-sm text-slate-600">C√¥ng c·ª• m·∫´u cho chuy√™n gia x√¢y d·ª±ng c√¥ng th·ª©c ‚Äì c√≥ b·∫£ng gi√°, dinh d∆∞·ª°ng ∆∞·ªõc t√≠nh v√† g·ª£i √Ω theo giai ƒëo·∫°n</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnPrint" class="hidden sm:inline-flex px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">In / Xu·∫•t PDF</button>
        <button id="btnReset" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm hover:bg-slate-50">L√†m m·ªõi</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 glass rounded-2xl p-4">
        <div class="flex flex-wrap items-center gap-3 justify-between">
          <div>
            <h2 class="text-lg font-semibold">B·ªô t·∫°o c√¥ng th·ª©c ph·ªëi tr·ªôn</h2>
            <p class="text-sm text-slate-600">Ch·ªçn ƒë·ªëi t∆∞·ª£ng nu√¥i & giai ƒëo·∫°n, r·ªìi t√πy ch·ªânh nguy√™n li·ªáu. C√¥ng c·ª• s·∫Ω t√≠nh <span class="font-medium">t·ªïng %</span>, <span class="font-medium">gi√°/kg</span> v√† <span class="font-medium">dinh d∆∞·ª°ng ∆∞·ªõc t√≠nh</span>.</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnLoadSample" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700">N·∫°p c√¥ng th·ª©c m·∫´u</button>
            <button id="btnAddRow" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm hover:bg-slate-50">+ Th√™m nguy√™n li·ªáu</button>
          </div>
        </div>

        <div class="mt-4 grid md:grid-cols-3 gap-3">
          <div class="glass2 rounded-2xl p-3">
            <label class="text-xs font-medium text-slate-700">ƒê·ªëi t∆∞·ª£ng</label>
            <select id="species" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white">
              <option value="chicken">G√† (gia c·∫ßm)</option>
              <option value="pig">Heo (l·ª£n)</option>
              <option value="cattle">B√≤</option>
              <option value="fish">C√° (th·ªßy s·∫£n)</option>
            </select>
          </div>
          <div class="glass2 rounded-2xl p-3">
            <label class="text-xs font-medium text-slate-700">Giai ƒëo·∫°n / ƒë·ªô tu·ªïi</label>
            <select id="stage" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"></select>
          </div>
          <div class="glass2 rounded-2xl p-3">
            <label class="text-xs font-medium text-slate-700">Kh·ªëi l∆∞·ª£ng ph·ªëi tr·ªôn (kg/m·∫ª)</label>
            <input id="batchKg" type="number" min="1" step="1" value="100" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" />
          </div>
        </div>

        <div class="mt-4 table-wrap glass2">
          <table class="text-sm">
            <thead>
              <tr class="text-left">
                <th style="width:220px">Nguy√™n li·ªáu</th>
                <th style="width:120px">T·ª∑ l·ªá (%)</th>
                <th style="width:140px">Gi√° (ƒë/kg)</th>
                <th style="width:110px">ME (kcal/kg)</th>
                <th style="width:90px">CP (%)</th>
                <th style="width:90px">Lys (%)</th>
                <th style="width:90px">Met (%)</th>
                <th style="width:90px">Ca (%)</th>
                <th style="width:90px">P kh·∫£ d·ª•ng (%)</th>
                <th style="width:120px">Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="mt-4 grid md:grid-cols-2 gap-3">
          <div class="glass2 rounded-2xl p-3">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">T·ªïng h·ª£p c√¥ng th·ª©c</h3>
              <span id="sumBadge" class="text-xs px-2 py-1 rounded-full bg-slate-900 text-white">‚Äî</span>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">T·ªïng t·ª∑ l·ªá</div>
                <div class="font-semibold" id="totalPct">0%</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">Gi√° th√†nh (ƒë/kg)</div>
                <div class="font-semibold" id="costPerKg">0</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">Gi√°/m·∫ª (ƒë)</div>
                <div class="font-semibold" id="costPerBatch">0</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">Kh·ªëi l∆∞·ª£ng/m·∫ª (kg)</div>
                <div class="font-semibold" id="batchOut">0</div>
              </div>
            </div>
            <div class="mt-3 text-xs text-slate-600">
              L∆∞u √Ω: Dinh d∆∞·ª°ng l√† <span class="font-medium">∆∞·ªõc t√≠nh tuy·∫øn t√≠nh</span> theo d·ªØ li·ªáu th√†nh ph·∫ßn ƒëi·ªÉn h√¨nh; c·∫ßn hi·ªáu ch·ªânh theo ph√¢n t√≠ch nguy√™n li·ªáu th·ª±c t·∫ø, quy ƒë·ªïi ch·∫•t kh√¥, h·ªá s·ªë ti√™u h√≥a v√† m·ª•c ti√™u t·ª´ng gi·ªëng/ƒëi·ªÅu ki·ªán.
            </div>
          </div>

          <div class="glass2 rounded-2xl p-3">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-semibold">So v·ªõi nhu c·∫ßu tham chi·∫øu</h3>
              <button id="btnAutoBalance" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs hover:bg-blue-700">G·ª£i √Ω c√¢n b·∫±ng nhanh</button>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">ME (kcal/kg)</div>
                <div class="font-semibold" id="meVal">‚Äî</div>
                <div class="text-xs" id="meNeed">‚Äî</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">ƒê·∫°m th√¥ CP (%)</div>
                <div class="font-semibold" id="cpVal">‚Äî</div>
                <div class="text-xs" id="cpNeed">‚Äî</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">Lys (%)</div>
                <div class="font-semibold" id="lysVal">‚Äî</div>
                <div class="text-xs" id="lysNeed">‚Äî</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">Met (%)</div>
                <div class="font-semibold" id="metVal">‚Äî</div>
                <div class="text-xs" id="metNeed">‚Äî</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">Ca (%)</div>
                <div class="font-semibold" id="caVal">‚Äî</div>
                <div class="text-xs" id="caNeed">‚Äî</div>
              </div>
              <div class="p-2 rounded-xl bg-white/70 border border-slate-200/70">
                <div class="text-xs text-slate-600">P kh·∫£ d·ª•ng (%)</div>
                <div class="font-semibold" id="pVal">‚Äî</div>
                <div class="text-xs" id="pNeed">‚Äî</div>
              </div>
            </div>
            <div class="mt-3 text-xs text-slate-600">
              Nhu c·∫ßu tham chi·∫øu ƒë∆∞·ª£c t·ªïng h·ª£p theo c√°c t√†i li·ªáu/khuy·∫øn ngh·ªã ph·ªï bi·∫øn (NRC, FAO v√† gi√°o tr√¨nh ƒë·∫°i h·ªçc). Khi √°p d·ª•ng th·ª±c t·∫ø c·∫ßn cƒÉn theo gi·ªëng, m·∫≠t ƒë·ªô, nhi·ªát ƒë·ªô, m·ª•c ti√™u tƒÉng tr∆∞·ªüng/ƒë·∫ª tr·ª©ng, v√† m·ª©c ƒë·ªô an to√†n sinh h·ªçc.
            </div>
          </div>
        </div>
      </div>

      <aside class="glass rounded-2xl p-4">
        <div class="flex items-start justify-between gap-2">
          <div>
            <h2 class="text-lg font-semibold">Gi√° nguy√™n li·ªáu</h2>
            <p class="text-sm text-slate-600">C·∫≠p nh·∫≠t theo th·ªùi ƒëi·ªÉm (m√¥ ph·ªèng/nh·∫≠p tay) v√† √°p d·ª•ng v√†o c√¥ng th·ª©c.</p>
          </div>
          <span id="priceStamp" class="text-xs px-2 py-1 rounded-full bg-slate-900 text-white">‚Äî</span>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnSimUpdate" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm hover:bg-slate-50">C·∫≠p nh·∫≠t (m√¥ ph·ªèng)</button>
          <button id="btnApplyPrices" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm hover:bg-blue-700">√Åp d·ª•ng v√†o c√¥ng th·ª©c</button>
          <button id="btnExport" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">Xu·∫•t JSON</button>
          <label class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm hover:bg-slate-50 cursor-pointer">
            Nh·∫≠p JSON
            <input id="importJson" type="file" accept="application/json" class="hidden" />
          </label>
        </div>

        <div class="mt-3 table-wrap glass2">
          <table class="text-sm" style="min-width: 0;">
            <thead>
              <tr class="text-left">
                <th>Nguy√™n li·ªáu</th>
                <th>Gi√° (ƒë/kg)</th>
              </tr>
            </thead>
            <tbody id="priceTable"></tbody>
          </table>
        </div>

        <div class="mt-4">
          <h3 class="font-semibold">Ngu·ªìn tham kh·∫£o ch√≠nh th·ªëng</h3>
          <ul class="mt-2 space-y-2 text-sm text-slate-700 list-disc pl-5">
            <li><a class="text-blue-700 hover:underline" target="_blank" href="https://nap.nationalacademies.org/">NRC / National Academies Press</a> (t√†i li·ªáu nhu c·∫ßu dinh d∆∞·ª°ng gia c·∫ßm, heo, b√≤)</li>
            <li><a class="text-blue-700 hover:underline" target="_blank" href="https://www.fao.org/">FAO</a> (h∆∞·ªõng d·∫´n nu√¥i d∆∞·ª°ng, th·ª©c ƒÉn chƒÉn nu√¥i & th·ªßy s·∫£n)</li>
            <li><a class="text-blue-700 hover:underline" target="_blank" href="https://www.ilri.org/">ILRI</a> (t√†i li·ªáu v·ªÅ chƒÉn nu√¥i, kh·∫©u ph·∫ßn, nƒÉng su·∫•t)</li>
            <li>Gi√°o tr√¨nh & b√†i gi·∫£ng dinh d∆∞·ª°ng v·∫≠t nu√¥i c·ªßa c√°c tr∆∞·ªùng/vi·ªán trong ng√†nh (ƒêH N√¥ng L√¢m, H·ªçc vi·ªán N√¥ng nghi·ªáp, Vi·ªán ChƒÉn nu√¥i‚Ä¶)</li>
          </ul>
          <p class="mt-3 text-xs text-slate-600">Trang n√†y l√† c√¥ng c·ª• h·ªó tr·ª£ l·∫≠p c√¥ng th·ª©c. Khi d√πng cho s·∫£n xu·∫•t c·∫ßn ki·ªÉm so√°t ch·∫•t l∆∞·ª£ng nguy√™n li·ªáu, ƒë·ªôc t·ªë n·∫•m m·ªëc, c√¢n ƒë·ªëi axit amin ti√™u h√≥a, kho√°ng vi l∆∞·ª£ng, v√† tu√¢n th·ªß quy ƒë·ªãnh an to√†n th·ª©c ƒÉn chƒÉn nu√¥i.</p>
        </div>
      </aside>
    </section>

    <section class="mt-4 glass rounded-2xl p-4">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">H∆∞·ªõng d·∫´n nhanh</h2>
          <p class="text-sm text-slate-600">Ch·ªçn c√¥ng th·ª©c m·∫´u, ƒëi·ªÅu ch·ªânh theo th·ªã tr∆∞·ªùng & m·ª•c ti√™u. C√≥ th·ªÉ th√™m nguy√™n li·ªáu m·ªõi v√† l∆∞u/nh·∫≠p JSON.</p>
        </div>
        <div class="flex gap-2 no-print">
          <button id="btnSaveLocal" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm hover:bg-slate-50">L∆∞u v√†o tr√¨nh duy·ªát</button>
          <button id="btnLoadLocal" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm hover:bg-slate-50">T·∫£i t·ª´ tr√¨nh duy·ªát</button>
        </div>
      </div>
      <div class="mt-3 grid md:grid-cols-3 gap-3 text-sm">
        <div class="glass2 rounded-2xl p-3">
          <div class="font-semibold">1) Ch·ªçn ƒë·ªëi t∆∞·ª£ng & giai ƒëo·∫°n</div>
          <div class="text-slate-600 mt-1">V√≠ d·ª•: <span class="font-medium">G√† th·ªãt ‚Äì Starter</span>, <span class="font-medium">Heo ‚Äì Grower</span>, <span class="font-medium">B√≤ ‚Äì v·ªó b√©o</span>, ho·∫∑c <span class="font-medium">C√° ‚Äì tƒÉng tr∆∞·ªüng</span>.</div>
        </div>
        <div class="glass2 rounded-2xl p-3">
          <div class="font-semibold">2) Ch·ªânh % v√† gi√° nguy√™n li·ªáu</div>
          <div class="text-slate-600 mt-1">T·ªïng % n√™n = <span class="font-medium">100</span>. Gi√° c√≥ th·ªÉ c·∫≠p nh·∫≠t theo th·ªùi ƒëi·ªÉm; b·∫•m <span class="font-medium">√Åp d·ª•ng v√†o c√¥ng th·ª©c</span>.</div>
        </div>
        <div class="glass2 rounded-2xl p-3">
          <div class="font-semibold">3) Ki·ªÉm tra dinh d∆∞·ª°ng & c√¢n b·∫±ng</div>
          <div class="text-slate-600 mt-1">D√πng <span class="font-medium">G·ª£i √Ω c√¢n b·∫±ng nhanh</span> (heuristic) ƒë·ªÉ tƒÉng/gi·∫£m b·∫Øp/kh√¥ d·∫ßu ƒë·∫≠u n√†nh/d·∫ßu/premix‚Ä¶</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="no-print max-w-7xl mx-auto px-4 pb-8 pt-2 text-xs text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-2">
      <div>¬© <span id="year"></span> FeedMix Lab ‚Äì Demo single-page. D·ªØ li·ªáu th√†nh ph·∫ßn l√† gi√° tr·ªã ƒëi·ªÉn h√¨nh ƒë·ªÉ minh h·ªça.</div>
      <div class="text-slate-500">M·∫πo: Nh·∫•n In / Xu·∫•t PDF ƒë·ªÉ l∆∞u c√¥ng th·ª©c.</div>
    </div>
  </footer>

  <script>
    // ---------- Data (typical composition; illustrative) ----------
    // Units: price VND/kg; ME kcal/kg; others are % as-fed.
    const ingredientDB = {
      "B·∫Øp (ng√¥)": { price: 8500, me: 3350, cp: 8.5, lys: 0.26, met: 0.18, ca: 0.03, p: 0.09 },
      "T·∫•m (g·∫°o)": { price: 8200, me: 3200, cp: 7.5, lys: 0.28, met: 0.16, ca: 0.02, p: 0.08 },
      "C√°m g·∫°o": { price: 9000, me: 2600, cp: 13.0, lys: 0.55, met: 0.25, ca: 0.08, p: 0.35 },
      "Kh√¥ d·∫ßu ƒë·∫≠u n√†nh": { price: 14500, me: 2450, cp: 46.0, lys: 2.90, met: 0.62, ca: 0.29, p: 0.62 },
      "B·ªôt c√°": { price: 26000, me: 2700, cp: 60.0, lys: 4.50, met: 1.60, ca: 5.00, p: 2.80 },
      "D·∫ßu th·ª±c v·∫≠t": { price: 26000, me: 8800, cp: 0.0, lys: 0.0, met: 0.0, ca: 0.00, p: 0.00 },
      "B·ªôt ƒë√° (CaCO3)": { price: 1200, me: 0, cp: 0.0, lys: 0.0, met: 0.0, ca: 38.0, p: 0.00 },
      "DCP (Dicalcium phosphate)": { price: 18500, me: 0, cp: 0.0, lys: 0.0, met: 0.0, ca: 23.0, p: 18.0 },
      "Mu·ªëi (NaCl)": { price: 2500, me: 0, cp: 0.0, lys: 0.0, met: 0.0, ca: 0.00, p: 0.00 },
      "Premix kho√°ng-vitamin": { price: 60000, me: 0, cp: 0.0, lys: 0.0, met: 0.0, ca: 0.00, p: 0.00 },
      "DL-Methionine": { price: 95000, me: 0, cp: 0.0, lys: 0.0, met: 99.0, ca: 0.00, p: 0.00 },
      "L-Lysine HCl": { price: 52000, me: 0, cp: 0.0, lys: 78.0, met: 0.0, ca: 0.00, p: 0.00 },
      "B·ªôt m√¨": { price: 9800, me: 3050, cp: 12.0, lys: 0.35, met: 0.18, ca: 0.05, p: 0.13 },
      "Kh√¥ d·∫ßu c·∫£i (canola meal)": { price: 11800, me: 2200, cp: 36.0, lys: 2.00, met: 0.70, ca: 0.70, p: 0.70 },
      "C√°m b·∫Øp (corn DDGS)": { price: 12000, me: 2800, cp: 27.0, lys: 0.95, met: 0.55, ca: 0.10, p: 0.35 },
      "R·ªâ m·∫≠t": { price: 5500, me: 2400, cp: 4.0, lys: 0.10, met: 0.05, ca: 0.90, p: 0.10 },
      "C·ªè kh√¥ (tham kh·∫£o cho b√≤)": { price: 2500, me: 1900, cp: 10.0, lys: 0.50, met: 0.20, ca: 0.60, p: 0.25 },
      "B√£ bia": { price: 4500, me: 2100, cp: 22.0, lys: 1.10, met: 0.35, ca: 0.30, p: 0.50 }
    };

    // Simplified requirement references per species & stage (illustrative ranges)
    const requirements = {
      chicken: {
        stages: [
          { id:"broiler_starter", name:"G√† th·ªãt ‚Äì Starter (0‚Äì3 tu·∫ßn)", need:{ me: 3000, cp: 21.5, lys: 1.15, met: 0.50, ca: 0.95, p: 0.45 } },
          { id:"broiler_grower", name:"G√† th·ªãt ‚Äì Grower (3‚Äì5 tu·∫ßn)", need:{ me: 3100, cp: 19.5, lys: 1.05, met: 0.47, ca: 0.90, p: 0.42 } },
          { id:"broiler_finisher", name:"G√† th·ªãt ‚Äì Finisher (5+ tu·∫ßn)", need:{ me: 3200, cp: 18.0, lys: 0.95, met: 0.43, ca: 0.85, p: 0.40 } },
          { id:"layer_peak", name:"G√† ƒë·∫ª ‚Äì ƒê·ªânh ƒë·∫ª", need:{ me: 2750, cp: 16.5, lys: 0.85, met: 0.38, ca: 3.80, p: 0.42 } }
        ]
      },
      pig: {
        stages: [
          { id:"pig_starter", name:"Heo ‚Äì Starter (7‚Äì20 kg)", need:{ me: 3300, cp: 20.0, lys: 1.35, met: 0.40, ca: 0.75, p: 0.35 } },
          { id:"pig_grower", name:"Heo ‚Äì Grower (20‚Äì50 kg)", need:{ me: 3250, cp: 18.0, lys: 1.05, met: 0.32, ca: 0.65, p: 0.30 } },
          { id:"pig_finisher", name:"Heo ‚Äì Finisher (50‚Äì100 kg)", need:{ me: 3200, cp: 16.0, lys: 0.80, met: 0.26, ca: 0.55, p: 0.25 } },
          { id:"sow_lact", name:"N√°i ‚Äì Nu√¥i con", need:{ me: 3300, cp: 18.5, lys: 1.00, met: 0.30, ca: 0.90, p: 0.40 } }
        ]
      },
      cattle: {
        stages: [
          { id:"calf_grow", name:"B√™ ‚Äì TƒÉng tr∆∞·ªüng", need:{ me: 2400, cp: 16.0, lys: 0.75, met: 0.25, ca: 0.70, p: 0.35 } },
          { id:"fattening", name:"B√≤ ‚Äì V·ªó b√©o", need:{ me: 2600, cp: 13.0, lys: 0.60, met: 0.22, ca: 0.60, p: 0.30 } },
          { id:"dairy", name:"B√≤ s·ªØa ‚Äì Khai th√°c s·ªØa", need:{ me: 2700, cp: 16.5, lys: 0.80, met: 0.28, ca: 0.80, p: 0.40 } }
        ]
      },
      fish: {
        stages: [
          { id:"fish_nursery", name:"C√° ‚Äì ∆Ø∆°ng gi·ªëng", need:{ me: 3000, cp: 34.0, lys: 1.70, met: 0.70, ca: 1.00, p: 0.60 } },
          { id:"fish_growout", name:"C√° ‚Äì TƒÉng tr∆∞·ªüng", need:{ me: 3200, cp: 30.0, lys: 1.50, met: 0.65, ca: 0.90, p: 0.55 } }
        ]
      }
    };

    // Sample formulas (percent must sum ~100)
    const sampleFormulas = {
      chicken: {
        broiler_starter: [
          { name:"B·∫Øp (ng√¥)", pct: 53 },
          { name:"Kh√¥ d·∫ßu ƒë·∫≠u n√†nh", pct: 32 },
          { name:"B·ªôt c√°", pct: 5 },
          { name:"D·∫ßu th·ª±c v·∫≠t", pct: 3 },
          { name:"B·ªôt ƒë√° (CaCO3)", pct: 1.2 },
          { name:"DCP (Dicalcium phosphate)", pct: 1.5 },
          { name:"Mu·ªëi (NaCl)", pct: 0.3 },
          { name:"Premix kho√°ng-vitamin", pct: 0.5 },
          { name:"L-Lysine HCl", pct: 0.3 },
          { name:"DL-Methionine", pct: 0.2 }
        ]
      },
      pig: {
        pig_grower: [
          { name:"B·∫Øp (ng√¥)", pct: 58 },
          { name:"T·∫•m (g·∫°o)", pct: 10 },
          { name:"Kh√¥ d·∫ßu ƒë·∫≠u n√†nh", pct: 24 },
          { name:"C√°m g·∫°o", pct: 5 },
          { name:"DCP (Dicalcium phosphate)", pct: 1.4 },
          { name:"B·ªôt ƒë√° (CaCO3)", pct: 0.9 },
          { name:"Mu·ªëi (NaCl)", pct: 0.3 },
          { name:"Premix kho√°ng-vitamin", pct: 0.3 },
          { name:"L-Lysine HCl", pct: 0.1 }
        ]
      },
      cattle: {
        fattening: [
          { name:"B·∫Øp (ng√¥)", pct: 35 },
          { name:"C√°m g·∫°o", pct: 12 },
          { name:"B√£ bia", pct: 15 },
          { name:"R·ªâ m·∫≠t", pct: 5 },
          { name:"C·ªè kh√¥ (tham kh·∫£o cho b√≤)", pct: 30 },
          { name:"Mu·ªëi (NaCl)", pct: 0.5 },
          { name:"Premix kho√°ng-vitamin", pct: 0.5 },
          { name:"B·ªôt ƒë√° (CaCO3)", pct: 2 }
        ]
      },
      fish: {
        fish_growout: [
          { name:"B·∫Øp (ng√¥)", pct: 25 },
          { name:"C√°m g·∫°o", pct: 15 },
          { name:"Kh√¥ d·∫ßu ƒë·∫≠u n√†nh", pct: 30 },
          { name:"B·ªôt c√°", pct: 18 },
          { name:"D·∫ßu th·ª±c v·∫≠t", pct: 5 },
          { name:"DCP (Dicalcium phosphate)", pct: 1.2 },
          { name:"B·ªôt ƒë√° (CaCO3)", pct: 0.6 },
          { name:"Mu·ªëi (NaCl)", pct: 0.2 },
          { name:"Premix kho√°ng-vitamin", pct: 0.5 },
          { name:"L-Lysine HCl", pct: 0.2 },
          { name:"DL-Methionine", pct: 0.1 }
        ]
      }
    };

    // ---------- State ----------
    const state = {
      formulaRows: [], // {name,pct,price,me,cp,lys,met,ca,p}
      prices: {},
      lastPriceUpdate: null
    };

    // ---------- Helpers ----------
    const fmt = new Intl.NumberFormat('vi-VN');
    const $ = (id) => document.getElementById(id);

    function nowStamp(){
      const d = new Date();
      return d.toLocaleString('vi-VN', { hour12:false });
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

    function getStageObj(){
      const sp = $('species').value;
      const st = $('stage').value;
      const found = requirements[sp].stages.find(s => s.id === st);
      return found || requirements[sp].stages[0];
    }

    function listIngredientNames(){
      return Object.keys(ingredientDB);
    }

    function ensurePricesInitialized(){
      if(Object.keys(state.prices).length) return;
      for(const [name, v] of Object.entries(ingredientDB)) state.prices[name] = v.price;
      state.lastPriceUpdate = new Date();
    }

    function toRow(name, pct){
      const ref = ingredientDB[name] || {price:0, me:0, cp:0, lys:0, met:0, ca:0, p:0};
      const price = state.prices[name] ?? ref.price ?? 0;
      return { name, pct: +pct || 0, price: +price || 0, me: ref.me||0, cp: ref.cp||0, lys: ref.lys||0, met: ref.met||0, ca: ref.ca||0, p: ref.p||0 };
    }

    function recomputeTotals(){
      const batchKg = +$('batchKg').value || 0;
      const totalPct = state.formulaRows.reduce((s,r)=> s + (+r.pct||0), 0);

      // Weighted sums by pct
      const w = (key) => state.formulaRows.reduce((s,r)=> s + ((+r.pct||0)/100) * (+r[key]||0), 0);
      const me = w('me');
      const cp = w('cp');
      const lys = w('lys');
      const met = w('met');
      const ca = w('ca');
      const p = w('p');

      const costPerKg = state.formulaRows.reduce((s,r)=> s + ((+r.pct||0)/100) * (+r.price||0), 0);
      const batchOut = batchKg * (totalPct/100);
      const costPerBatch = costPerKg * batchOut;

      $('totalPct').textContent = totalPct.toFixed(2) + '%';
      $('costPerKg').textContent = fmt.format(Math.round(costPerKg));
      $('batchOut').textContent = fmt.format(Math.round(batchOut*100)/100);
      $('costPerBatch').textContent = fmt.format(Math.round(costPerBatch));

      $('meVal').textContent = Math.round(me);
      $('cpVal').textContent = cp.toFixed(2);
      $('lysVal').textContent = lys.toFixed(3);
      $('metVal').textContent = met.toFixed(3);
      $('caVal').textContent = ca.toFixed(2);
      $('pVal').textContent = p.toFixed(3);

      const need = getStageObj().need;
      $('meNeed').textContent = `Nhu c·∫ßu: ~${need.me} kcal/kg`;
      $('cpNeed').textContent = `Nhu c·∫ßu: ~${need.cp}%`;
      $('lysNeed').textContent = `Nhu c·∫ßu: ~${need.lys}%`;
      $('metNeed').textContent = `Nhu c·∫ßu: ~${need.met}%`;
      $('caNeed').textContent = `Nhu c·∫ßu: ~${need.ca}%`;
      $('pNeed').textContent = `Nhu c·∫ßu: ~${need.p}%`;

      // Badge
      const ok = Math.abs(totalPct - 100) <= 0.05;
      const warn = Math.abs(totalPct - 100) <= 1.0;
      $('sumBadge').textContent = ok ? 'OK: 100%' : (warn ? 'G·∫ßn ƒë·ªß' : 'Ch∆∞a c√¢n');
      $('sumBadge').className = 'text-xs px-2 py-1 rounded-full text-white ' + (ok ? 'bg-emerald-600' : (warn ? 'bg-amber-600' : 'bg-rose-600'));

      // highlight deficits/excess (simple)
      paintNeed('meVal', me, need.me, 100);
      paintNeed('cpVal', cp, need.cp, 1.0);
      paintNeed('lysVal', lys, need.lys, 0.05);
      paintNeed('metVal', met, need.met, 0.03);
      paintNeed('caVal', ca, need.ca, 0.10);
      paintNeed('pVal', p, need.p, 0.05);
    }

    function paintNeed(elId, val, need, tol){
      const el = $(elId);
      const diff = val - need;
      let cls = 'text-slate-900';
      if(Math.abs(diff) <= tol) cls = 'text-emerald-700';
      else if(diff < 0) cls = 'text-rose-700';
      else cls = 'text-amber-700';
      el.className = 'font-semibold ' + cls;
    }

    function renderStageOptions(){
      const sp = $('species').value;
      const stSel = $('stage');
      const prev = stSel.value;
      stSel.innerHTML = '';
      for(const s of requirements[sp].stages){
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        stSel.appendChild(opt);
      }
      // keep previous if exists
      if([...stSel.options].some(o => o.value === prev)) stSel.value = prev;
      recomputeTotals();
    }

    function renderRows(){
      const tbody = $('rows');
      tbody.innerHTML = '';
      const names = listIngredientNames();

      state.formulaRows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/60';

        const tdName = document.createElement('td');
        const sel = document.createElement('select');
        sel.className = 'w-full px-2 py-2 rounded-xl border border-slate-200 bg-white';

        // Put current name first if custom
        const opts = new Set(names);
        if(!opts.has(r.name)){
          const opt0 = document.createElement('option');
          opt0.value = r.name;
          opt0.textContent = r.name + ' (t·ª± th√™m)';
          sel.appendChild(opt0);
        }
        for(const n of names){
          const opt = document.createElement('option');
          opt.value = n;
          opt.textContent = n;
          sel.appendChild(opt);
        }
        sel.value = r.name;
        sel.addEventListener('change', () => {
          const name = sel.value;
          state.formulaRows[idx] = { ...toRow(name, r.pct) };
          renderRows();
          recomputeTotals();
        });
        tdName.appendChild(sel);

        const tdPct = document.createElement('td');
        tdPct.appendChild(numInput(r.pct, 0, 100, 0.01, (v)=>{ r.pct = v; recomputeTotals(); }));

        const tdPrice = document.createElement('td');
        tdPrice.appendChild(numInput(r.price, 0, 500000, 1, (v)=>{ r.price = v; recomputeTotals(); }));

        const tdME = document.createElement('td');
        tdME.appendChild(numInput(r.me, 0, 12000, 1, (v)=>{ r.me = v; recomputeTotals(); }));

        const tdCP = document.createElement('td');
        tdCP.appendChild(numInput(r.cp, 0, 90, 0.01, (v)=>{ r.cp = v; recomputeTotals(); }));

        const tdLys = document.createElement('td');
        tdLys.appendChild(numInput(r.lys, 0, 100, 0.001, (v)=>{ r.lys = v; recomputeTotals(); }));

        const tdMet = document.createElement('td');
        tdMet.appendChild(numInput(r.met, 0, 100, 0.001, (v)=>{ r.met = v; recomputeTotals(); }));

        const tdCa = document.createElement('td');
        tdCa.appendChild(numInput(r.ca, 0, 50, 0.01, (v)=>{ r.ca = v; recomputeTotals(); }));

        const tdP = document.createElement('td');
        tdP.appendChild(numInput(r.p, 0, 50, 0.001, (v)=>{ r.p = v; recomputeTotals(); }));

        const tdAct = document.createElement('td');
        const wrap = document.createElement('div');
        wrap.className = 'flex gap-2';
        const btnDup = document.createElement('button');
        btnDup.className = 'px-2 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50';
        btnDup.textContent = 'Nh√¢n';
        btnDup.addEventListener('click', ()=>{
          state.formulaRows.splice(idx+1, 0, deepClone(r));
          renderRows();
          recomputeTotals();
        });
        const btnDel = document.createElement('button');
        btnDel.className = 'px-2 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700';
        btnDel.textContent = 'X√≥a';
        btnDel.addEventListener('click', ()=>{
          state.formulaRows.splice(idx, 1);
          renderRows();
          recomputeTotals();
        });
        wrap.appendChild(btnDup);
        wrap.appendChild(btnDel);
        tdAct.appendChild(wrap);

        [tdName, tdPct, tdPrice, tdME, tdCP, tdLys, tdMet, tdCa, tdP, tdAct].forEach(td=>tr.appendChild(td));
        tbody.appendChild(tr);
      });

      if(state.formulaRows.length === 0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 10;
        td.className = 'p-4 text-center text-slate-600';
        td.textContent = 'Ch∆∞a c√≥ nguy√™n li·ªáu. B·∫•m ‚ÄúN·∫°p c√¥ng th·ª©c m·∫´u‚Äù ho·∫∑c ‚Äú+ Th√™m nguy√™n li·ªáu‚Äù.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    function numInput(value, min, max, step, onChange){
      const input = document.createElement('input');
      input.type = 'number';
      input.value = (value ?? 0);
      input.min = min;
      input.max = max;
      input.step = step;
      input.className = 'w-full px-2 py-2 rounded-xl border border-slate-200 bg-white';
      input.addEventListener('input', () => {
        const v = clamp(parseFloat(input.value || '0'), min, max);
        onChange(v);
      });
      return input;
    }

    function renderPriceTable(){
      ensurePricesInitialized();
      const tbody = $('priceTable');
      tbody.innerHTML = '';
      for(const name of Object.keys(state.prices).sort((a,b)=>a.localeCompare(b,'vi'))){
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/60';

        const tdN = document.createElement('td');
        tdN.className = 'py-2';
        tdN.textContent = name;

        const tdP = document.createElement('td');
        const inp = document.createElement('input');
        inp.type = 'number';
        inp.min = 0;
        inp.step = 1;
        inp.value = state.prices[name];
        inp.className = 'w-full px-2 py-2 rounded-xl border border-slate-200 bg-white';
        inp.addEventListener('input', () => {
          state.prices[name] = Math.max(0, Math.round(+inp.value || 0));
          state.lastPriceUpdate = new Date();
          updatePriceStamp();
        });
        tdP.appendChild(inp);

        tr.appendChild(tdN);
        tr.appendChild(tdP);
        tbody.appendChild(tr);
      }
      updatePriceStamp();
    }

    function updatePriceStamp(){
      $('priceStamp').textContent = state.lastPriceUpdate ? ('C·∫≠p nh·∫≠t: ' + state.lastPriceUpdate.toLocaleString('vi-VN',{hour12:false})) : 'Ch∆∞a c·∫≠p nh·∫≠t';
    }

    function applyPricesToFormula(){
      ensurePricesInitialized();
      state.formulaRows.forEach(r => {
        if(state.prices[r.name] != null) r.price = state.prices[r.name];
      });
      renderRows();
      recomputeTotals();
    }

    function loadSample(){
      const sp = $('species').value;
      const st = $('stage').value;
      const pick = sampleFormulas[sp]?.[st] || sampleFormulas[sp]?.[Object.keys(sampleFormulas[sp]||{})[0]];
      if(!pick){
        state.formulaRows = [toRow('B·∫Øp (ng√¥)', 60), toRow('Kh√¥ d·∫ßu ƒë·∫≠u n√†nh', 30), toRow('Premix kho√°ng-vitamin', 0.5)];
      } else {
        state.formulaRows = pick.map(x => toRow(x.name, x.pct));
      }
      // Ensure at least one protein source for heuristic
      renderRows();
      recomputeTotals();
    }

    function addEmptyRow(){
      const first = listIngredientNames()[0] || 'B·∫Øp (ng√¥)';
      state.formulaRows.push(toRow(first, 0));
      renderRows();
      recomputeTotals();
    }

    // Simple heuristic balancer (not a linear program)
    function autoBalance(){
      if(state.formulaRows.length === 0) loadSample();
      const need = getStageObj().need;

      const findRow = (name) => state.formulaRows.find(r => r.name === name);
      const ensureRow = (name) => {
        let r = findRow(name);
        if(!r){
          r = toRow(name, 0);
          state.formulaRows.push(r);
        }
        return r;
      };

      const corn = ensureRow('B·∫Øp (ng√¥)');
      const sbm = ensureRow('Kh√¥ d·∫ßu ƒë·∫≠u n√†nh');
      const oil = ensureRow('D·∫ßu th·ª±c v·∫≠t');
      const premix = ensureRow('Premix kho√°ng-vitamin');

      // Keep premix within 0.3‚Äì1.0
      premix.pct = clamp(premix.pct || 0.5, 0.3, 1.0);

      // Make total close to 100 by adjusting corn
      const totalPct = state.formulaRows.reduce((s,r)=> s + (+r.pct||0), 0);
      corn.pct += (100 - totalPct);

      // Iterate adjustments
      for(let it=0; it<12; it++){
        // recompute current
        const w = (key) => state.formulaRows.reduce((s,r)=> s + ((+r.pct||0)/100) * (+r[key]||0), 0);
        const me = w('me');
        const cp = w('cp');
        const lys = w('lys');
        const met = w('met');

        // ME: adjust oil vs corn
        if(me < need.me - 70){
          const delta = 0.4;
          oil.pct = clamp((oil.pct||0) + delta, 0, 8);
          corn.pct -= delta;
        } else if(me > need.me + 120){
          const delta = 0.4;
          oil.pct = clamp((oil.pct||0) - delta, 0, 8);
          corn.pct += delta;
        }

        // CP: adjust SBM vs corn
        if(cp < need.cp - 0.4){
          const delta = 0.8;
          sbm.pct = clamp((sbm.pct||0) + delta, 0, 55);
          corn.pct -= delta;
        } else if(cp > need.cp + 0.8){
          const delta = 0.6;
          sbm.pct = clamp((sbm.pct||0) - delta, 0, 55);
          corn.pct += delta;
        }

        // AA: add synthetic if lacking
        const lysAdd = ensureRow('L-Lysine HCl');
        const metAdd = ensureRow('DL-Methionine');

        if(lys < need.lys - 0.03){
          const delta = 0.05;
          lysAdd.pct = clamp((lysAdd.pct||0) + delta, 0, 0.6);
          corn.pct -= delta;
        }
        if(met < need.met - 0.02){
          const delta = 0.03;
          metAdd.pct = clamp((metAdd.pct||0) + delta, 0, 0.4);
          corn.pct -= delta;
        }

        // Keep non-negative
        corn.pct = Math.max(-5, corn.pct);
      }

      // Final normalize: scale to 100 if close
      let sum = state.formulaRows.reduce((s,r)=> s + (+r.pct||0), 0);
      if(sum !== 0){
        const k = 100 / sum;
        state.formulaRows.forEach(r => r.pct = Math.max(0, r.pct * k));
      }

      renderRows();
      recomputeTotals();
    }

    function simulatePriceUpdate(){
      ensurePricesInitialized();
      // random walk +/- 0‚Äì6%
      for(const name of Object.keys(state.prices)){
        const base = state.prices[name];
        const change = (Math.random()*0.12 - 0.06);
        const next = Math.max(0, Math.round(base * (1 + change)));
        state.prices[name] = next;
      }
      state.lastPriceUpdate = new Date();
      renderPriceTable();
    }

    function exportJSON(){
      const payload = {
        meta: { exportedAt: new Date().toISOString(), app: 'FeedMix Lab Demo' },
        selection: { species: $('species').value, stage: $('stage').value, batchKg: +$('batchKg').value || 100 },
        prices: state.prices,
        formula: state.formulaRows
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `feedmix_${$('species').value}_${$('stage').value}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJSONFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(reader.result);
          if(data?.selection?.species) $('species').value = data.selection.species;
          renderStageOptions();
          if(data?.selection?.stage) $('stage').value = data.selection.stage;
          if(data?.selection?.batchKg) $('batchKg').value = data.selection.batchKg;

          if(data?.prices && typeof data.prices === 'object'){
            state.prices = data.prices;
            state.lastPriceUpdate = new Date();
            renderPriceTable();
          }
          if(Array.isArray(data?.formula)){
            state.formulaRows = data.formula.map(r => ({
              name: r.name,
              pct: +r.pct || 0,
              price: +r.price || (state.prices[r.name] ?? ingredientDB[r.name]?.price ?? 0),
              me: +r.me || ingredientDB[r.name]?.me || 0,
              cp: +r.cp || ingredientDB[r.name]?.cp || 0,
              lys: +r.lys || ingredientDB[r.name]?.lys || 0,
              met: +r.met || ingredientDB[r.name]?.met || 0,
              ca: +r.ca || ingredientDB[r.name]?.ca || 0,
              p: +r.p || ingredientDB[r.name]?.p || 0
            }));
            renderRows();
            recomputeTotals();
          }
        } catch(e){
          alert('File JSON kh√¥ng h·ª£p l·ªá.');
        }
      };
      reader.readAsText(file);
    }

    function saveLocal(){
      const data = {
        selection: { species: $('species').value, stage: $('stage').value, batchKg: +$('batchKg').value || 100 },
        prices: state.prices,
        formula: state.formulaRows,
        updatedAt: new Date().toISOString()
      };
      localStorage.setItem('feedmix_demo', JSON.stringify(data));
      alert('ƒê√£ l∆∞u v√†o tr√¨nh duy·ªát.');
    }

    function loadLocal(){
      const raw = localStorage.getItem('feedmix_demo');
      if(!raw){ alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë√£ l∆∞u.'); return; }
      try{
        const data = JSON.parse(raw);
        if(data?.selection?.species) $('species').value = data.selection.species;
        renderStageOptions();
        if(data?.selection?.stage) $('stage').value = data.selection.stage;
        if(data?.selection?.batchKg) $('batchKg').value = data.selection.batchKg;
        if(data?.prices) state.prices = data.prices;
        state.lastPriceUpdate = new Date();
        renderPriceTable();
        if(Array.isArray(data?.formula)) state.formulaRows = data.formula;
        renderRows();
        recomputeTotals();
      } catch{ alert('D·ªØ li·ªáu l∆∞u b·ªã l·ªói.'); }
    }

    function resetAll(){
      state.formulaRows = [];
      state.prices = {};
      state.lastPriceUpdate = null;
      $('batchKg').value = 100;
      $('species').value = 'chicken';
      renderStageOptions();
      renderPriceTable();
      renderRows();
      recomputeTotals();
    }

    // ---------- Events ----------
    $('species').addEventListener('change', () => {
      renderStageOptions();
    });
    $('stage').addEventListener('change', () => recomputeTotals());
    $('batchKg').addEventListener('input', () => recomputeTotals());

    $('btnLoadSample').addEventListener('click', loadSample);
    $('btnAddRow').addEventListener('click', addEmptyRow);
    $('btnApplyPrices').addEventListener('click', applyPricesToFormula);
    $('btnSimUpdate').addEventListener('click', simulatePriceUpdate);
    $('btnAutoBalance').addEventListener('click', autoBalance);
    $('btnExport').addEventListener('click', exportJSON);
    $('importJson').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if(f) importJSONFile(f);
      e.target.value = '';
    });

    $('btnSaveLocal').addEventListener('click', saveLocal);
    $('btnLoadLocal').addEventListener('click', loadLocal);

    $('btnReset').addEventListener('click', resetAll);
    $('btnPrint').addEventListener('click', () => window.print());

    // ---------- Init ----------
    $('year').textContent = new Date().getFullYear();
    renderStageOptions();
    ensurePricesInitialized();
    renderPriceTable();
    loadSample();
  </script>
</body>
</html>
